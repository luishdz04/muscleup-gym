# üîÑ Sistema de Sincronizaci√≥n de Roles - Documentaci√≥n Completa

## üìã Resumen

Tu sistema tendr√° **2 componentes** que trabajan juntos:

1. **Script de sincronizaci√≥n inicial** (`sync-roles-to-metadata.ts`)
   - Ejecutar **UNA SOLA VEZ** para sincronizar usuarios existentes
   - Sincroniza TODOS los usuarios (con o sin rol)
   - Los usuarios sin rol ‚Üí se asigna 'cliente' por defecto

2. **Trigger autom√°tico** (`create-role-sync-trigger.sql`)
   - Se ejecuta **AUTOM√ÅTICAMENTE** en cada INSERT o UPDATE
   - Mantiene sincronizados Users.rol ‚Üî auth.users.metadata.role
   - Reemplaza/complementa tu trigger `on_user_update_sync_rol`

---

## üéØ Flujo Completo

```mermaid
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PASO 1: SINCRONIZACI√ìN INICIAL (una sola vez)              ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  $ npx tsx scripts/sync-roles-to-metadata.ts               ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  ‚úÖ Sincroniza TODOS los usuarios existentes                ‚îÇ
‚îÇ  ‚úÖ Usuarios con rol ‚Üí mantiene su rol                      ‚îÇ
‚îÇ  ‚úÖ Usuarios sin rol ‚Üí asigna 'cliente'                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PASO 2: CREAR TRIGGER AUTOM√ÅTICO (una sola vez)            ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  Ejecutar SQL en Supabase:                                  ‚îÇ
‚îÇ  scripts/create-role-sync-trigger.sql                       ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  ‚úÖ Se activa autom√°ticamente en INSERT (nuevo registro)    ‚îÇ
‚îÇ  ‚úÖ Se activa autom√°ticamente en UPDATE (cambio de rol)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PASO 3: DE AHORA EN ADELANTE (autom√°tico)                  ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ
‚îÇ  ‚úÖ Nuevo usuario se registra ‚Üí Trigger sincroniza          ‚îÇ
‚îÇ  ‚úÖ Se actualiza rol en Users ‚Üí Trigger sincroniza          ‚îÇ
‚îÇ  ‚úÖ Se actualiza nombre ‚Üí Trigger sincroniza                ‚îÇ
‚îÇ  ‚úÖ NO REQUIERE INTERVENCI√ìN MANUAL                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîß Comparaci√≥n: Trigger Anterior vs Nuevo

### Tu trigger actual: `on_user_update_sync_rol`

Copia aqu√≠ el SQL de tu trigger para analizarlo. Probablemente hace algo como:

```sql
-- Ejemplo de lo que PODR√çA ser tu trigger actual:
CREATE TRIGGER on_user_update_sync_rol
AFTER UPDATE ON "Users"
FOR EACH ROW
EXECUTE FUNCTION alguna_funcion_sync();
```

### Nuevo trigger: `sync_role_metadata_trigger`

```sql
-- Se activa en INSERT (registro) Y UPDATE (cambio)
CREATE TRIGGER sync_role_metadata_trigger
AFTER INSERT OR UPDATE OF rol, "firstName", "lastName" ON "Users"
FOR EACH ROW
EXECUTE FUNCTION sync_role_to_metadata();
```

**Ventajas del nuevo:**
- ‚úÖ Se activa en **INSERT** (tu trigger actual probablemente solo en UPDATE)
- ‚úÖ Se activa solo cuando cambian campos espec√≠ficos (m√°s eficiente)
- ‚úÖ Sincroniza rol + nombre (m√°s completo)
- ‚úÖ Maneja metadata null con COALESCE

---

## üöÄ Instrucciones de Instalaci√≥n

### Opci√≥n A: Reemplazar trigger anterior (RECOMENDADO)

Si tu trigger `on_user_update_sync_rol` hace lo mismo pero menos completo:

1. **Ejecutar script TypeScript** (sincroniza existentes):
   ```bash
   npx tsx scripts/sync-roles-to-metadata.ts
   ```

2. **Ejecutar SQL completo** (crea trigger nuevo y elimina el anterior):
   ```sql
   -- El script autom√°ticamente hace:
   DROP TRIGGER IF EXISTS on_user_update_sync_rol ON "Users";
   -- Y crea el nuevo trigger
   ```

### Opci√≥n B: Mantener ambos (NO RECOMENDADO)

Si tu trigger hace algo adicional que necesitas:

1. **Revisar qu√© hace tu trigger actual** (necesito el SQL)
2. **Fusionar funcionalidades** en una sola funci√≥n
3. **Evitar duplicar la sincronizaci√≥n**

---

## üìä Casos de Uso Cubiertos

### ‚úÖ Caso 1: Usuario NUEVO se registra

**Flujo:**
```
1. Usuario completa registro
2. Se inserta en tabla "Users" con rol (o null)
3. üîÑ TRIGGER se dispara autom√°ticamente
4. ‚úÖ Sincroniza a auth.users.metadata.role
5. Usuario inicia sesi√≥n ‚Üí JWT ya tiene el rol
```

### ‚úÖ Caso 2: Cambiar rol de usuario existente

**Flujo:**
```
1. Admin cambia rol en tabla Users (admin ‚Üí empleado)
2. üîÑ TRIGGER se dispara autom√°ticamente
3. ‚úÖ Actualiza auth.users.metadata.role
4. Usuario debe cerrar/abrir sesi√≥n para refrescar JWT
```

### ‚úÖ Caso 3: Usuario sin rol definido

**Flujo:**
```
1. Usuario tiene rol = NULL en tabla Users
2. Script de sincronizaci√≥n asigna rol = 'cliente'
3. üîÑ Metadata actualizado con 'cliente'
4. Middleware usa 'cliente' como default
```

### ‚úÖ Caso 4: Usuarios existentes (hist√≥ricos)

**Flujo:**
```
1. Ejecutar script: npx tsx scripts/sync-roles-to-metadata.ts
2. ‚úÖ TODOS los usuarios se sincronizan en batch
3. Script muestra reporte: X exitosos, Y errores
4. Usuarios deben cerrar/abrir sesi√≥n
```

---

## üîç Verificaci√≥n Post-Instalaci√≥n

### 1. Verificar que el trigger existe:
```sql
SELECT 
  t.tgname as trigger_name,
  pg_get_triggerdef(t.oid) as trigger_definition
FROM pg_trigger t
JOIN pg_class c ON t.tgrelid = c.oid
WHERE c.relname = 'Users'
  AND t.tgname = 'sync_role_metadata_trigger';
```

### 2. Verificar cu√°ntos usuarios tienen metadata:
```sql
SELECT 
  COUNT(*) FILTER (WHERE raw_user_meta_data->>'role' IS NOT NULL) as con_metadata,
  COUNT(*) FILTER (WHERE raw_user_meta_data->>'role' IS NULL) as sin_metadata,
  COUNT(*) as total
FROM auth.users;
```

### 3. Verificar usuarios espec√≠ficos:
```sql
SELECT 
  u.email,
  u.rol as tabla_rol,
  au.raw_user_meta_data->>'role' as metadata_role,
  CASE 
    WHEN u.rol = au.raw_user_meta_data->>'role' THEN '‚úÖ Sincronizado'
    ELSE '‚ùå Desincronizado'
  END as estado
FROM "Users" u
JOIN auth.users au ON u.id = au.id
WHERE u.email IN (
  'ing.luisdeluna@outlook.com',
  'administracion@muscleupgym.fitness',
  'luisdeluna04@hotmail.com'
);
```

### 4. Probar el trigger manualmente:
```sql
-- Cambiar un rol
UPDATE "Users" 
SET rol = 'empleado' 
WHERE email = 'ing.luisdeluna@outlook.com';

-- Verificar que se sincroniz√≥
SELECT 
  email,
  raw_user_meta_data->>'role' as metadata_role
FROM auth.users
WHERE email = 'ing.luisdeluna@outlook.com';
-- Deber√≠a mostrar 'empleado'
```

---

## ‚ö†Ô∏è Importante: Sesiones de Usuarios

**Despu√©s de sincronizar roles, los usuarios DEBEN:**

1. **Cerrar sesi√≥n completamente**
2. **Volver a iniciar sesi√≥n**
3. **Esto refresca su JWT** con el nuevo metadata

Sin esto, seguir√°n usando el JWT antiguo (sin metadata).

### Alternativa: Forzar refresh desde c√≥digo

```typescript
// En el cliente
const { data: { session } } = await supabase.auth.refreshSession();
```

---

## üêõ Troubleshooting

### Problema: "SUPABASE_SERVICE_ROLE_KEY no definida"

**Soluci√≥n:**
```bash
# .env.local debe tener:
SUPABASE_SERVICE_ROLE_KEY=tu_service_role_key_aqui
```

**Obtener el key:**
1. Ir a Supabase Dashboard
2. Settings ‚Üí API
3. Copiar "service_role key" (NO el anon key)

### Problema: "Permission denied to update auth.users"

**Causa:** No est√°s usando el service_role key

**Soluci√≥n:** Verificar que el script usa `SUPABASE_SERVICE_ROLE_KEY`, no `NEXT_PUBLIC_SUPABASE_ANON_KEY`

### Problema: "Trigger no se dispara"

**Verificar:**
```sql
-- Ver si el trigger existe
SELECT * FROM pg_trigger WHERE tgname = 'sync_role_metadata_trigger';

-- Ver si la funci√≥n existe
SELECT * FROM pg_proc WHERE proname = 'sync_role_to_metadata';

-- Verificar logs (si pusiste RAISE NOTICE)
-- Los logs aparecen en Supabase Dashboard ‚Üí Database ‚Üí Logs
```

### Problema: "Usuarios siguen sin poder acceder a rutas admin"

**Causas posibles:**
1. No cerraron/abrieron sesi√≥n
2. Metadata no se sincroniz√≥
3. Middleware no est√° leyendo metadata

**Soluci√≥n:**
```sql
-- Verificar metadata
SELECT email, raw_user_meta_data->>'role' 
FROM auth.users 
WHERE email = 'usuario@problema.com';

-- Si est√° null, sincronizar manualmente:
UPDATE auth.users
SET raw_user_meta_data = raw_user_meta_data || '{"role":"admin"}'::jsonb
WHERE email = 'usuario@problema.com';
```

---

## üìù Checklist Final

### Instalaci√≥n:
- [ ] Ejecutar `npx tsx scripts/sync-roles-to-metadata.ts`
- [ ] Ejecutar SQL `scripts/create-role-sync-trigger.sql`
- [ ] Verificar que trigger existe en Supabase
- [ ] Verificar usuarios espec√≠ficos tienen metadata

### Post-Instalaci√≥n:
- [ ] Usuarios admin cierran/abren sesi√≥n
- [ ] Probar acceso a rutas admin
- [ ] Probar crear usuario nuevo (verificar auto-sync)
- [ ] Probar cambiar rol (verificar auto-sync)

### Validaci√≥n:
- [ ] Middleware lee `user.user_metadata?.role`
- [ ] No hay queries a tabla Users en middleware
- [ ] Logs muestran "Rol desde metadata"
- [ ] Performance mejorado (verificar tiempos)

---

## üéØ Pr√≥ximos Pasos

1. **Copia aqu√≠ el SQL de tu trigger `on_user_update_sync_rol`**
   - Para verificar si hay conflictos
   - Para fusionar funcionalidades si es necesario

2. **Ejecuta el script de sincronizaci√≥n**
   ```bash
   npx tsx scripts/sync-roles-to-metadata.ts
   ```

3. **Ejecuta el SQL del trigger**
   - En Supabase SQL Editor
   - Contenido de: `scripts/create-role-sync-trigger.sql`

4. **Prueba completa**
   - Login con usuario admin
   - Verificar acceso a rutas
   - Crear usuario nuevo
   - Cambiar rol de usuario

---

¬øTienes el SQL de tu trigger `on_user_update_sync_rol`? C√≥pialo aqu√≠ para analizarlo y asegurar compatibilidad. üöÄ
