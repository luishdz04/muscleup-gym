2025-06-20 00:13:33,274 [INFO] 
🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓
2025-06-20 00:13:33,275 [INFO] [STARTUP] SERVICIO F22 v5.1 CORREGIDO CON Z_ACUnlock FUNCIONAL
2025-06-20 00:13:33,275 [INFO] 🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓
2025-06-20 00:13:33,275 [INFO] [INFO] 📅 Fecha/Hora: 2025-06-20 06:10:01 UTC
2025-06-20 00:13:33,277 [INFO] [INFO] 👤 Usuario: mupai555
2025-06-20 00:13:33,278 [INFO] [INFO] 🔒 Modo de seguridad: ULTRA_STRICT
2025-06-20 00:13:33,278 [INFO] [INFO] 🚫 Offline mode: False (FALSE = SEGURO)
2025-06-20 00:13:33,278 [INFO] [INFO] 🌐 Dispositivo F22: 192.168.1.201:4370
2025-06-20 00:13:33,278 [INFO] [INFO] 🎯 Puerto WebSocket: 8082
2025-06-20 00:13:33,278 [INFO] 
2025-06-20 00:13:33,278 [INFO] [FEATURES] 🛡️ CARACTERÍSTICAS CORREGIDAS:
2025-06-20 00:13:33,278 [INFO]    ✅ STA Thread para eventos COM REALES (OnAttTransactionEx)
2025-06-20 00:13:33,278 [INFO]    ✅ ZKEventHandler CORREGIDO sin parámetros en constructor
2025-06-20 00:13:33,278 [INFO]    ✅ pythoncom.PumpMessages() para callbacks en tiempo real
2025-06-20 00:13:33,278 [INFO]    ✅ 👆 REGISTRO DE HUELLAS con formato MUP (firstName lastName)
2025-06-20 00:13:33,278 [INFO]    ✅ 🔐 Validación BULLETPROOF con tu esquema de BD
2025-06-20 00:13:33,278 [INFO]    ✅ 📋 fingerprint_templates -> Users -> user_memberships
2025-06-20 00:13:33,278 [INFO]    ✅ 📊 Logs automáticos en access_logs
2025-06-20 00:13:33,278 [INFO]    ✅ 🎯 Monitoreo en tiempo real con validación inmediata
2025-06-20 00:13:33,278 [INFO]    ✅ 🔓 Z_ACUnlock - FUNCIÓN OFICIAL ZKTECO PARA ABRIR PUERTAS
2025-06-20 00:13:33,278 [INFO]    ✅ ⚡ ACUnlock, SetDeviceInfo, ControlDevice y más métodos
2025-06-20 00:13:33,278 [INFO]    ✅ 🔧 Control directo de relé físico
2025-06-20 00:13:33,278 [INFO]    ✅ 🔒 CERO tolerancia a errores de seguridad
2025-06-20 00:13:33,278 [INFO]    ✅ 🎮 WebSocket API completa SIN ERRORES
2025-06-20 00:13:33,279 [INFO]    ✅ 🚫 MÉTODOS FALTANTES AGREGADOS (_send_heartbeat, _cleanup)
2025-06-20 00:13:33,279 [INFO] 🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓
2025-06-20 00:13:33,279 [INFO] [STARTUP] 🔗 Iniciando conexión F22 CORREGIDA CON Z_ACUnlock...
2025-06-20 00:13:33,279 [INFO] [SERVICE] 🚀 Iniciando servicio F22 CORREGIDO v5.1...
2025-06-20 00:13:33,279 [INFO] [VERIFY] 🔍 Verificando conexión a Supabase...
2025-06-20 00:13:34,349 [INFO] [VERIFY] ✅ Conexión a Supabase verificada
2025-06-20 00:13:34,350 [INFO] [STA_THREAD] 🧵 Thread STA COMPLETAMENTE CORREGIDO inicializado
2025-06-20 00:13:34,350 [INFO] [STA_THREAD] ✅ COM inicializado en modo STA
2025-06-20 00:13:34,351 [INFO] [STA_THREAD] 🔗 Conectando a F22 CORREGIDO en 192.168.1.201:4370
2025-06-20 00:13:35,047 [INFO] [STA_THREAD] ✅ Conectado al F22
2025-06-20 00:13:35,088 [INFO] [STA_THREAD] 📋 Info dispositivo: {'serial': 'BOCK192461543', 'firmware': 'Unknown'}
2025-06-20 00:13:35,089 [INFO] [STA_THREAD] 🔧 DESHABILITANDO control automático del dispositivo...
2025-06-20 00:13:35,359 [INFO] [SUCCESS] ✅ Servicio F22 CORREGIDO iniciado
2025-06-20 00:13:35,360 [INFO] [SUCCESS] 🔐 Eventos COM reales activos
2025-06-20 00:13:35,361 [INFO] [SUCCESS] 👆 Registro de huellas activo
2025-06-20 00:13:35,362 [INFO] [SUCCESS] 🎯 Validación con tu BD activa
2025-06-20 00:13:35,362 [INFO] [SUCCESS] 🚪 Control de puerta con Z_ACUnlock FUNCIONAL
2025-06-20 00:13:35,363 [INFO] [STARTUP] ✅ Conexión F22 CORREGIDA establecida
2025-06-20 00:13:35,363 [INFO] [STARTUP] 🌐 Iniciando WebSocket F22 CORREGIDO...
2025-06-20 00:13:35,382 [INFO] [SUCCESS] 🚀 Sistema F22 CORREGIDO activo en puerto 8082
2025-06-20 00:13:35,382 [INFO] 
2025-06-20 00:13:35,382 [INFO] [READY] 🎯 Sistema listo - CON Z_ACUnlock FUNCIONAL
2025-06-20 00:13:35,382 [INFO] [READY] 🔐 Monitoreo en tiempo real con eventos COM
2025-06-20 00:13:35,382 [INFO] [READY] 👆 Registro de huellas (MUP format) listo
2025-06-20 00:13:35,382 [INFO] [READY] 📊 Logs automáticos en access_logs activos
2025-06-20 00:13:35,382 [INFO] [READY] 🔓 Control de puerta con Z_ACUnlock OFICIAL
2025-06-20 00:13:35,382 [INFO] [READY] ⚡ Relé físico controlado por software
2025-06-20 00:13:35,382 [INFO] 
2025-06-20 00:13:35,382 [INFO] [IMPORTANT] 🧪 PRUEBA TODAS LAS FUNCIONALIDADES:
2025-06-20 00:13:35,382 [INFO]    1. 👤 Usuario CON membresía activa → DEBE abrir puerta con Z_ACUnlock ✅
2025-06-20 00:13:35,383 [INFO]    2. ❌ Usuario SIN membresía → DEBE DENEGAR acceso
2025-06-20 00:13:35,383 [INFO]    3. ❓ Usuario no registrado → DEBE DENEGAR acceso
2025-06-20 00:13:35,383 [INFO]    4. 👆 Registrar nueva huella → Usar 'enroll_user'
2025-06-20 00:13:35,383 [INFO]    5. 📊 Verificar logs en access_logs automáticamente
2025-06-20 00:13:35,383 [INFO]    6. 🔓 Probar apertura manual → Usar 'open_door' (Z_ACUnlock)
2025-06-20 00:13:35,383 [INFO] 
2025-06-20 00:13:35,383 [INFO] [WEBSOCKET] 🌐 API CORREGIDA disponible en:
2025-06-20 00:13:35,383 [INFO]    ws://127.0.0.1:8082
2025-06-20 00:13:35,383 [INFO] 
2025-06-20 00:13:35,383 [INFO] [API] 🎮 Acciones disponibles:
2025-06-20 00:13:35,383 [INFO]    - get_device_info: Info del dispositivo + contadores
2025-06-20 00:13:35,383 [INFO]    - test_access: Probar validación de usuario
2025-06-20 00:13:35,383 [INFO]    - open_door: Abrir puerta con Z_ACUnlock (OFICIAL)
2025-06-20 00:13:35,383 [INFO]    - enroll_user: Registrar huella (requiere user_data)
2025-06-20 00:13:35,383 [INFO]    - get_enrollment_status: Estado del registro
2025-06-20 00:13:35,383 [INFO]    - connect_device: Conectar dispositivo
2025-06-20 00:13:35,383 [INFO]    - disconnect_device: Desconectar dispositivo
2025-06-20 00:13:35,383 [INFO]    - get_service_status: Estado completo del servicio
2025-06-20 00:13:35,383 [INFO] 
2025-06-20 00:13:35,383 [INFO] 🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓
2025-06-20 00:13:35,383 [INFO] [STATUS] ✅ SISTEMA F22 CORREGIDO CON Z_ACUnlock FUNCIONAL ACTIVO
2025-06-20 00:13:35,383 [INFO] [STATUS] 👆 PON TU DEDO EN EL F22 PARA PROBAR MONITOREO
2025-06-20 00:13:35,383 [INFO] [STATUS] 🔓 LA PUERTA AHORA SÍ DEBE ABRIRSE CON Z_ACUnlock
2025-06-20 00:13:35,384 [INFO] [STATUS] 📝 USA API WEBSOCKET PARA REGISTRAR HUELLAS
2025-06-20 00:13:35,384 [INFO] [STATUS] 🚫 TODOS LOS ERRORES CORREGIDOS
2025-06-20 00:13:35,384 [INFO] 🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓🔓
2025-06-20 00:13:39,608 [INFO] [STA_THREAD] ✅ Control aplicado: 32 opciones
2025-06-20 00:13:39,608 [INFO] [STA_THREAD] 🔒 El dispositivo NO debe abrir puertas automáticamente
2025-06-20 00:13:39,656 [INFO] [STA_THREAD] ✅ Eventos COM registrados (65535 = todos)
2025-06-20 00:13:39,703 [INFO] [STA_THREAD] 🚀 Monitoreo CORREGIDO con eventos COM activo
2025-06-20 00:13:39,704 [INFO] [STA_THREAD] 🚪 Control de puerta con Z_ACUnlock FUNCIONAL
2025-06-20 00:13:39,705 [INFO] [FINGERPRINT] 🔧 Inicializando gestor de huellas...
2025-06-20 00:13:40,905 [INFO] [FINGERPRINT] 📋 Cargando usuarios del dispositivo...
2025-06-20 00:13:41,065 [INFO] [FINGERPRINT] ✅ 0 usuarios cargados
2025-06-20 00:13:42,048 [INFO] [FINGERPRINT] ✅ Gestor inicializado - Próximo ID: 7266
2025-06-20 00:13:42,049 [INFO] [STA_THREAD] ✅ Fingerprint manager inicializado
2025-06-20 00:13:42,050 [INFO] [STA_THREAD] 🔄 Iniciando loop STA CORREGIDO
2025-06-20 00:14:09,466 [INFO] [COM_EVENT] 👆 HUELLA DETECTADA! Usuario: 7265
2025-06-20 00:14:09,473 [INFO] 🚨 HUELLA VÁLIDA DETECTADA - INICIANDO VALIDACIÓN 🚨
2025-06-20 00:14:09,474 [INFO] [STA_THREAD] 🔄 Procesando evento para usuario 7265
2025-06-20 00:14:09,475 [INFO] [ACCESS] 🔐 === VALIDACIÓN CORREGIDA INICIADA ===
2025-06-20 00:14:09,476 [INFO] [ACCESS] 👤 Usuario: 7265
2025-06-20 00:14:09,476 [INFO] [SECURITY] 🔐 Validación BULLETPROOF para usuario 7265
2025-06-20 00:14:10,809 [INFO] [SECURITY] 👤 Usuario encontrado: Erick Francisco De Luna (UUID: 67378a76-78dc-49d9-9864-83aef6754961)
2025-06-20 00:14:13,629 [WARNING] [SECURITY] ⏰ Fuera de horario: Fuera de horario (06:00 - 23:00)
2025-06-20 00:14:13,629 [WARNING] [ACCESS] ❌ ACCESO DENEGADO
2025-06-20 00:14:13,629 [WARNING] [ACCESS] 👤 Usuario: Erick Francisco De Luna
2025-06-20 00:14:13,629 [WARNING] [ACCESS] 📝 Razón: Fuera de horario (06:00 - 23:00)
2025-06-20 00:14:15,774 [INFO] [LOG] ✅ Acceso registrado en BD: denied, usuario 7265
2025-06-20 00:14:15,775 [INFO] [ACCESS] 🔐 === VALIDACIÓN COMPLETADA ===
2025-06-20 00:18:35,845 [INFO] [STATUS] 📊 === STATUS CORREGIDO CON Z_ACUnlock ===
2025-06-20 00:18:35,846 [INFO] [STATUS] ⏰ Uptime: 0:05:02.572085
2025-06-20 00:18:35,847 [INFO] [STATUS] 🧵 STA Thread: ✅ ACTIVO
2025-06-20 00:18:35,847 [INFO] [STATUS] 📡 Eventos COM: ✅ ACTIVOS
2025-06-20 00:18:35,847 [INFO] [STATUS] 👆 Registro activo: ❌ NO
2025-06-20 00:18:35,848 [INFO] [STATUS] 👥 Clientes WebSocket: 0
2025-06-20 00:18:35,848 [INFO] [STATUS] 📈 Eventos procesados: 1
2025-06-20 00:18:35,848 [INFO] [STATUS] ✅ Accesos permitidos: 0
2025-06-20 00:18:35,849 [INFO] [STATUS] ❌ Accesos denegados: 1
2025-06-20 00:18:35,849 [INFO] [STATUS] 🚨 Violaciones de seguridad: 0
2025-06-20 00:18:35,849 [INFO] [STATUS] 👤 Usuarios en dispositivo: 0
2025-06-20 00:18:35,850 [INFO] [STATUS] 👆 Huellas en BD: 0
2025-06-20 00:18:35,850 [INFO] [STATUS] 🔓 Puertas abiertas con Z_ACUnlock: 0
2025-06-20 00:18:35,851 [INFO] [STATUS] ❌ Errores de puerta: 0
2025-06-20 00:23:36,573 [INFO] [STATUS] 📊 === STATUS CORREGIDO CON Z_ACUnlock ===
2025-06-20 00:23:36,574 [INFO] [STATUS] ⏰ Uptime: 0:10:03.300698
2025-06-20 00:23:36,575 [INFO] [STATUS] 🧵 STA Thread: ✅ ACTIVO
2025-06-20 00:23:36,575 [INFO] [STATUS] 📡 Eventos COM: ✅ ACTIVOS
2025-06-20 00:23:36,576 [INFO] [STATUS] 👆 Registro activo: ❌ NO
2025-06-20 00:23:36,576 [INFO] [STATUS] 👥 Clientes WebSocket: 0
2025-06-20 00:23:36,577 [INFO] [STATUS] 📈 Eventos procesados: 1
2025-06-20 00:23:36,577 [INFO] [STATUS] ✅ Accesos permitidos: 0
2025-06-20 00:23:36,578 [INFO] [STATUS] ❌ Accesos denegados: 1
2025-06-20 00:23:36,578 [INFO] [STATUS] 🚨 Violaciones de seguridad: 0
2025-06-20 00:23:36,579 [INFO] [STATUS] 👤 Usuarios en dispositivo: 0
2025-06-20 00:23:36,580 [INFO] [STATUS] 👆 Huellas en BD: 0
2025-06-20 00:23:36,581 [INFO] [STATUS] 🔓 Puertas abiertas con Z_ACUnlock: 0
2025-06-20 00:23:36,581 [INFO] [STATUS] ❌ Errores de puerta: 0
2025-06-20 00:28:37,276 [INFO] [STATUS] 📊 === STATUS CORREGIDO CON Z_ACUnlock ===
2025-06-20 00:28:37,276 [INFO] [STATUS] ⏰ Uptime: 0:15:04.003163
2025-06-20 00:28:37,276 [INFO] [STATUS] 🧵 STA Thread: ✅ ACTIVO
2025-06-20 00:28:37,277 [INFO] [STATUS] 📡 Eventos COM: ✅ ACTIVOS
2025-06-20 00:28:37,277 [INFO] [STATUS] 👆 Registro activo: ❌ NO
2025-06-20 00:28:37,277 [INFO] [STATUS] 👥 Clientes WebSocket: 0
2025-06-20 00:28:37,277 [INFO] [STATUS] 📈 Eventos procesados: 1
2025-06-20 00:28:37,278 [INFO] [STATUS] ✅ Accesos permitidos: 0
2025-06-20 00:28:37,278 [INFO] [STATUS] ❌ Accesos denegados: 1
2025-06-20 00:28:37,278 [INFO] [STATUS] 🚨 Violaciones de seguridad: 0
2025-06-20 00:28:37,278 [INFO] [STATUS] 👤 Usuarios en dispositivo: 0
2025-06-20 00:28:37,279 [INFO] [STATUS] 👆 Huellas en BD: 0
2025-06-20 00:28:37,279 [INFO] [STATUS] 🔓 Puertas abiertas con Z_ACUnlock: 0
2025-06-20 00:28:37,279 [INFO] [STATUS] ❌ Errores de puerta: 0
2025-06-20 00:33:37,289 [INFO] [STATUS] 📊 === STATUS CORREGIDO CON Z_ACUnlock ===
2025-06-20 00:33:37,289 [INFO] [STATUS] ⏰ Uptime: 0:20:04.016207
2025-06-20 00:33:37,289 [INFO] [STATUS] 🧵 STA Thread: ✅ ACTIVO
2025-06-20 00:33:37,290 [INFO] [STATUS] 📡 Eventos COM: ✅ ACTIVOS
2025-06-20 00:33:37,290 [INFO] [STATUS] 👆 Registro activo: ❌ NO
2025-06-20 00:33:37,290 [INFO] [STATUS] 👥 Clientes WebSocket: 0
2025-06-20 00:33:37,290 [INFO] [STATUS] 📈 Eventos procesados: 1
2025-06-20 00:33:37,291 [INFO] [STATUS] ✅ Accesos permitidos: 0
2025-06-20 00:33:37,291 [INFO] [STATUS] ❌ Accesos denegados: 1
2025-06-20 00:33:37,291 [INFO] [STATUS] 🚨 Violaciones de seguridad: 0
2025-06-20 00:33:37,291 [INFO] [STATUS] 👤 Usuarios en dispositivo: 0
2025-06-20 00:33:37,292 [INFO] [STATUS] 👆 Huellas en BD: 0
2025-06-20 00:33:37,292 [INFO] [STATUS] 🔓 Puertas abiertas con Z_ACUnlock: 0
2025-06-20 00:33:37,292 [INFO] [STATUS] ❌ Errores de puerta: 0
2025-06-20 00:35:49,526 [INFO] [SHUTDOWN] 🛑 Iniciando apagado CORREGIDO (SIGINT)
2025-06-20 00:35:49,528 [INFO] [STA_THREAD] 🧹 Limpiando recursos CORREGIDOS...
2025-06-20 00:35:49,666 [INFO] [STA_THREAD] ✅ Recursos CORREGIDOS liberados
2025-06-20 00:35:49,667 [INFO] [STA_THREAD] 🧵 Thread STA CORREGIDO finalizado
2025-06-20 00:35:50,083 [INFO] [SHUTDOWN] 🛑 Cerrando WebSocket F22 CORREGIDO...
2025-06-20 00:35:50,085 [INFO] [SERVICE] 🛑 Deteniendo servicio CORREGIDO...
2025-06-20 00:35:50,085 [INFO] [SERVICE] ✅ Servicio CORREGIDO detenido
2025-06-20 00:35:50,085 [INFO] [SHUTDOWN] ✅ Sistema F22 CORREGIDO cerrado limpiamente
2025-06-20 00:35:50,091 [INFO] [SHUTDOWN] 🧹 Limpiando recursos CORREGIDOS...
2025-06-20 00:35:50,091 [INFO] [SHUTDOWN] ✅ Recursos CORREGIDOS liberados
